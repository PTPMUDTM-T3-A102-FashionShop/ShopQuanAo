@model List<WebsiteBanQuanAo.Models.ChiTietSanPham>
@{
    ViewBag.Title = "Chi Tiết";
    Layout = "~/Views/Shared/_LayoutPage1.cshtml";
}

@section slmua {
    <span id="cartItemCount">@ViewBag.SLSP</span>
}
@section css{
    <style>

        #main_product_image {
            width: 100%;
            max-height: 400px; 
            object-fit: contain;
        }


        .thumbnail-images ul {
            padding-left: 0;
            display: flex;
            overflow-x: auto;
            gap: 10px;
        }

        .thumbnail-images .list-inline-item {
            cursor: pointer;
        }

        .thumbnail-images img {
            width: 100px; 
            height: 100px; 
            object-fit: cover; 
            border: 2px solid transparent;
            transition: border 0.3s ease;
        }

            .thumbnail-images img:hover {
                border: 2px solid #007bff; 
            }
    </style>
}
@{
    decimal gia = ViewBag.sanpham.Gia;
}
<div class="container mt-5">
    <div style="height:100px"></div>

    <div class="card">
        <div class="row g-0">
            <div class="col-md-6">
                <div class="d-flex flex-column justify-content-center">
                    <div class="main-image">
                        <img src="~/img/@Model[0].HinhAnhUrl" id="main_product_image" class="img-fluid" alt="Product Image">
                    </div>
                    <div class="thumbnail-images mt-3">
                        <ul id="thumbnail" class="list-inline">
                            @foreach (var item in Model)
                            {
                                if (!string.IsNullOrEmpty(item.HinhAnhUrl))
                                {
                                    string[] dsHinh = item.HinhAnhUrl.Trim().Split(',');
                                    foreach (var image in dsHinh)
                                    {
                                        <li class="list-inline-item">
                                            <img onclick="changeImage(this)" src="~/img/@image.Trim()" class="img-thumbnail" width="100">
                                        </li>
                                    }
                                }
                            }
                        </ul>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="p-3 d-flex flex-column justify-content-between">
                    <br />
                    <h3>Tên sản phẩm: @ViewBag.sanpham.SanPham.TenSanPham</h3>
                    <div class="mt-2 content">
                        <p>Mô Tả: @ViewBag.sanpham.SanPham.MoTa)</p>
                    </div>
                    <h3 class="mt-3">Giá: <span id="giaSanPham">@gia</span></h3>


                    <div class="form-group mt-3">
                        <label>Size:</label>
                        <div class="form-group mt-3">
                            <label>Size:</label>
                            <select id="sizeSelect" class="form-select" onchange="filterColors()">
                                <option value="">Chọn Size</option>
                                @foreach (var item in Model)
                                {
                                   
                                    <option value="@item.SizeID" data-size-name="@item.Size.TenSize">@item.Size.TenSize</option>
                                }
                            </select>
                        </div>

                        <div class="form-group mt-3">
                            <label>Màu:</label>
                            <select id="colorSelect" class="form-select" onchange="updatePrice()" disabled>
                                <option value="">Chọn Màu</option>
                                @foreach (var item in Model)
                                {
                                    bool isSelectedColor = item.MauID == ViewBag.sanpham.MauID; 
                                    <option value="@item.MauID" data-sizeid="@item.SizeID" @(isSelectedColor ? "selected" : "")>@item.Mau.TenMau</option>
                                }
                            </select>
                        </div>

                        <script>
                            // Khi trang được tải, xử lý size và màu
                            window.onload = function() {
                                const sizeSelect = document.getElementById('sizeSelect');
                                const colorSelect = document.getElementById('colorSelect');
                                const options = sizeSelect.getElementsByTagName('option');
                                const defaultSizeID = '@ViewBag.sanpham.SizeID';  
                                const defaultColorID = '@ViewBag.sanpham.MauID'; 
                                const uniqueSizes = [];

                               
                                for (let i = 1; i < options.length; i++) {
                                    const sizeName = options[i].getAttribute('data-size-name');

                                    if (!uniqueSizes.includes(sizeName)) {
                                        uniqueSizes.push(sizeName);
                                    } else {
                                 
                                        options[i].remove();
                                    }
                                }

                               
                                for (let i = 0; i < options.length; i++) {
                                    const sizeID = options[i].value;
                                    if (sizeID === defaultSizeID) {
                                        options[i].selected = true;  
                                        break;
                                    }
                                }

                                
                                sizeSelect.addEventListener('change', function() {
                                    if (sizeSelect.value) {
                             
                                        colorSelect.disabled = false;

                                        const colorOptions = colorSelect.getElementsByTagName('option');
                                        for (let i = 1; i < colorOptions.length; i++) { 
                                            const sizeID = colorOptions[i].getAttribute('data-sizeid');
                                            if (sizeID !== sizeSelect.value) {
                                                colorOptions[i].style.display = 'none';
                                            } else {
                                                colorOptions[i].style.display = 'block'; 
                                            }
                                        }

                                    } else {
                                      
                                        colorSelect.disabled = true;
                                       
                                        colorSelect.value = '';
                                    }
                                });

                               
                                if (sizeSelect.value) {
                                    colorSelect.disabled = false;

                                    const colorOptions = colorSelect.getElementsByTagName('option');
                                    for (let i = 1; i < colorOptions.length; i++) {
                                        const sizeID = colorOptions[i].getAttribute('data-sizeid');
                                        if (sizeID !== sizeSelect.value) {
                                            colorOptions[i].style.display = 'none'; 
                                        } else {
                                            colorOptions[i].style.display = 'block'; 
                                        }
                                    }
                                }
                            };
                        </script>




                      
                        <div class="buttons d-flex flex-row mt-4 gap-3">
                            <button type="button" class="btn btn-dark" onclick="addToCart()">Thêm Giỏ Hàng</button>
                        </div>

                    </div>
                </div>
            </div>
        </div>


        <div style="padding: 20px;">
            <h2 style="text-align: left;">Bình luận về sản phẩm</h2>

            @if (ViewBag.phanhoi != null && ViewBag.phanhoi.Count > 0)
            {
                <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 15px; background-color: #f9f9f9;">
                    @foreach (var phanHoi in ViewBag.phanhoi)
                    {
                        <div style="margin-bottom: 20px; padding: 10px; border-radius: 8px; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <p style="font-size: 16px; font-weight: bold; color: #333;">@phanHoi.NguoiDung.TenDangNhap</p>
                            <p style="font-size: 12px; color: #777; margin-bottom: 10px;">
                                <em>@phanHoi.NgayPhanHoi.ToString("dd/MM/yyyy")</em>
                            </p>
                            <p style="font-size: 14px; color: #555;">@phanHoi.NoiDung</p>
                        </div>
                    }
                </div>
            }
            else
            {
                <p style="font-size: 16px; color: #888; text-align: left;">Chưa có bình luận nào.</p>
            }
        </div>


        <a href="/product" class="btn btn-outline-primary mt-3">
            <i class="fas fa-arrow-left"></i>
            <span class="ms-2">Quay lại danh sách sản phẩm</span>
        </a>
    </div>

    <script>

    function changeImage(element) {
                var mainImage = document.getElementById("main_product_image");
                mainImage.src = element.src; 
            }
            function updatePrice() {
                var sizeValue = document.getElementById('sizeSelect').value;
                var colorValue = document.getElementById('colorSelect').value;
                var productID = @Model[0].SanPhamID;

                if (!sizeValue || !colorValue) {
                    return; 
                }

   
    $.ajax({
                url: '/Product/GetPrice',
        type: 'GET',
        data: { sizeID: sizeValue, colorID: colorValue, productID: productID },
        success: function(response) {
            
            $('#giaSanPham').text(response.gia);
                    },
        error: function() {
                        alert('Có lỗi xảy ra khi lấy giá.');
                    }
                });
            }

            function addToCart() {
                var sizeValue = document.getElementById('sizeSelect').value;
                var colorValue = document.getElementById('colorSelect').value;

                if (!sizeValue || !colorValue) {
                    alert('Vui lòng chọn Size và Màu trước khi thêm vào giỏ hàng.');
                    return false; 
                }

         
                var baseUrl = '@Url.Action("Add", "Cart", new { id = Model[0].SanPhamID })';
                var addToCartUrl = `${baseUrl}?sizeID=${encodeURIComponent(sizeValue)}&colorID=${encodeURIComponent(colorValue)}`;

          
                window.location.href = addToCartUrl;
            }



            function filterColors() {
                var selectedSize = document.getElementById('sizeSelect').value;
                var colorOptions = document.getElementById('colorSelect').options;

                // Hiện/ẩn các lựa chọn màu sắc dựa trên Size đã chọn
                for (var i = 0; i < colorOptions.length; i++) {
                    var option = colorOptions[i];
                    if (selectedSize) {
                        if (option.getAttribute('data-sizeid') === selectedSize) {
                            option.style.display = 'block'; // Hiển thị màu sắc phù hợp với size
                        } else {
                            option.style.display = 'none'; // Ẩn màu sắc không phù hợp với size
                        }
                    } else {
                        option.style.display = 'block'; // Nếu không chọn size, hiển thị tất cả màu sắc
                    }
                }

                // Đặt lại giá trị màu sắc đã chọn (nếu có)
                document.getElementById('colorSelect').value = "";
                updatePrice(); // Cập nhật giá lại sau khi thay đổi
            }

    </script>
